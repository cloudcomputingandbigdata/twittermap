(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
var tweetLoader = require('./tweetLoader');


$('#select').dropdown({
  useLabels: true,
  apiSettings: {
    url: '/twittermap/keywords'
  },
  onChange: function(text, value) {
    tweetLoader.loadByKeyword(value).done(function(data) {
      console.log(data);
      // re-initiate the geoJsonLayer
      geoJsonLayer.clearLayers();
      var scroll_id = data._scroll_id;
      var intervalId = window.setInterval(function() {
        tweetLoader.scroll(scroll_id).done(function(value) {
          console.log(value);
          if (value.hits.length === 0) {
            window.clearInterval(intervalId);
          } else {
            geoJsonLayer.addData(value.hits);
          }
        });
      }, 200);
    });
  }
});


L.mapbox.accessToken = 'pk.eyJ1IjoiaG91bGlhbmdsdiIsImEiOiJjaWwzMjNtcjEzbGdvdWdtM2c4bjNyeG1lIn0.fZxFewEvPi90HGANZnrkyA';
/*var geojson = [{
  "type": "Feature",
  "geometry": {
    "type": "Point",
    "coordinates": [-77.03238901390978, 38.913188059745586]
  },
  "properties": {
    "title": "Mapbox DC",
    "description": "1714 14th St NW, Washington DC",
    "marker-color": "#fc4353",
    "marker-size": "large",
    "marker-symbol": "monument"
  }
}, {
  "type": "Feature",
  "geometry": {
    "type": "Point",
    "coordinates": [-122.414, 37.776]
  },
  "properties": {
    "title": "Mapbox SF",
    "description": "155 9th St, San Francisco",
    "marker-color": "#fc4353",
    "marker-size": "large",
    "marker-symbol": "harbor"
  }
}];*/

var mapbox = L.mapbox.map('map', 'houlianglv.p8o27ai7');
mapbox.setView([40.71, -74.0059], 4);
var geoJsonLayer = L.geoJson([], {
  onEachFeature: function(feature, layer) {
    layer.bindPopup(
      "<div class='tweet-popup'>" +
      "<div class='author'>" + feature.properties.title + "</div>" +
      "<div class='date'>" + feature.properties.datetime + "</div>" +
      "<div class='contents'>" + feature.properties.description + "</div>" +
      "</div>"
    );
  }
}).addTo(mapbox);

},{"./tweetLoader":2}],2:[function(require,module,exports){
var tweetLoader = {};
tweetLoader.loadByKeyword = function(keyword) {
	var dtd = $.Deferred();
	$.ajax({
		url: "/search/" + keyword,
		type: 'GET'
	}).done(function(data) {
		dtd.resolve(data);
	})
	return dtd.promise();
};

tweetLoader.loadAll = function(){
	return this.loadByKeyword('');
}

tweetLoader.scroll = function(scrollId) {
	var dtd = $.Deferred();
	$.ajax({
		url: '/scroll/' + scrollId,
		type: 'GET'
	}).done(function(data){
		dtd.resolve(data);
	});
	return dtd.promise();
}

module.exports = tweetLoader;

},{}]},{},[1]);
